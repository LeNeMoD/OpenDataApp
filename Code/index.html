<!DOCTYPE html>
<html>
    <head>
        <!-- responsive style viewport for mobile  wichtig für boodstrap responsive -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- to include the language <html lang="en"> to the page -->

        <!-- Charset -->
        <meta charset="utf-8">

        <!-- Offline resources -->
        <!-- todo: Add d3 Bootstrap JQuery -->

        <link rel="stylesheet" type="text/css" href="externalCss.css">


        <!-- Online resources -->
        <!-- d3 -->
        <script src="https://d3js.org/d3.v4.js"></script> 
        <!-- JQuery --> 
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <!-- Popper -->         
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
        <!-- latest Bootstrap’s compiled CSS and JS --> 
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>

        <!-- external CSS -->
        <link rel="stylesheet" type="text/css" href="externalCss.css">


    </head>


    <body>
        <div class="container-fluid ">
            <div class="row display-flex">
                <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4" >
                    <div class="form-group">
                        <select multiple class="form-control" id="sidebar">
                        </select>
                    </div>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-8 col-lg-8">
                    <div id="diagramm">
                    </div>
                </div>
            </div>    
        </div>
        <!--<div class="row"> 
<div class="col-2" >
</div>
<div class="col-8">
<div id="diagramm">
</div>
</div>
<div class="col-2" >
</div>
</div>-->

        <script>

            var selectedPestizide;





            d3.json("2013-Cut-Pestizide-JSON.json" , function(error,data){
                if (error) throw error;
                //console.log(data);

                //Format data
                data.forEach(function(d) {
                    //console.log(d.Datum_Start);
                    d.Datum_Start = parseDate(d.Datum_Start);
                    d.M_in_mg_L = d.M_in_mg_L;

                });
                
                var nestedData = renderNestParams(data);
                //console.log(nestedData);

                //console.log(data[1].Datum_Start);
                //console.log(data[1].M_in_mg_L);

                //-------------------date conversion function-----------------//
                function parseDate(d){
                    var parseDate = d3.timeParse("%d.%m.%Y");
                    datum = new Date(parseDate(d));
                    var formattedDate = d3.timeFormat("%Y%m%d");
                    //console.log(datum);
                    //console.log(formattedDate(datum));
                    return formattedDate(datum);}
                //-------------------end date conversion function-----------------//

                //--------------start render .. nest data for parameter --------------//
                
                function renderNestParams(data){
                    var nested = d3.nest()
                        .key(function(d) {return d["Parameter"];})
                        .entries(data);
                    
                    //d3.select("body").append("pre")
                    //    .text(JSON.stringify(nested, null, 2));
                    //console.log(nested);
                    return nested;
                }
                
                //--------------end render .. nest data for parameter --------------//
                
                //-------------------start diagram-----------------//
                
                var outherWidth = 500;
                var outherHeight = 250;
                var margin = {left: 50, top: 5, right: 50, bottom: 5};
                
                var innerWidth = outherWidth - margin.left - margin.right;
                var innerHeight = outherHeight -margin.top - margin.bottom;
                
                var xColumn = "Datum_Start";
                var yColumn = "M_in_mg_L";
                
                var xAxisLabelText = "Datum";
                var xAxisLabelOffset = 50;
                var yAxisLabelText = "Milligramm";
                var yAxisLabelOffset = 50;
                
                var svg = d3.select("#diagramm").append("svg")
                    .attr("border","12px");
                    .("width", )
                
                var svg = d3.select("#diagramm").append("svg")
                .attr("border","12px");

                var margin = {top: 20, right: 20, bottom: 30, left: 50},
                    width = 960 - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;

                // set the ranges
                var x = d3.scaleTime().range([0, width]);
                var y = d3.scaleLinear().range([height, 0]);

                // define the line
                var valueline = d3.line()
                .x(function(d) { //console.log(d.Datum_Start);
                    return x(d.Datum_Start); })
                .y(function(d) { //console.log(d.M_in_mg_L);
                    return y(d.M_in_mg_L); });
 
                // Scale the range of the data
                x.domain(d3.extent(data, function(d) { return d[xColumn]; }));
                y.domain([0, d3.max(data, function(d) { return d[yColumn]; })]);

                // Add the valueline path.
                svg.append("path")
                    .data([data])
                    .attr("class", "line")
                    .attr("d", valueline);

                // Add the X Axis
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                // Add the Y Axis
                svg.append("g")
                    .call(d3.axisLeft(y));



                /**
                    //-------------------time conversion-----------------//
                    //richtiges datum string
                    console.log(data[1].PbNahmeDatum);

                    //parser
                    var parseDate = d3.timeParse("%d.%m.%Y");

                    //new date from old string with new format gives all exact out
                    datum = new Date(parseDate(data[1].PbNahmeDatum));
                    console.log(datum);

                    //millis von korrekt gedrehtem datum für example bostok
                    console.log(Date.parse(datum));
                    var formattedDate = d3.timeFormat("%Y%m%d");
                    console.log(formattedDate(datum));
                    //-------------------time conversion-----------------//
                    */



                //---------List Sorting-------//
                //sort list for the Parameter Types and safe to Array
                var existingParameters = [];
                for(i=0; i<data.length; i++){
                    existingParameters.indexOf(data[i].Parameter) === -1 ? existingParameters.push(data[i].Parameter) : null ;

                }  
                //---------List Sorting-------//

                //console.log(existingParameters);

                var ul = d3.select('#sidebar')
                .selectAll('option')
                .data(existingParameters)
                .enter()
                .append('option')
                .html(String)
                });


        </script>

    </body>
</html>