<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

        <!-- d3 library -->
        <script src="https://d3js.org/d3.v4.min.js"></script>

        <!-- jQuery library -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

        <!-- Latest compiled JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

        <link rel="stylesheet" type="text/css" href="APPCSS.css">

    </head>
    <body data-spy="scroll" data-target=".navbar" data-offset="50">

        <!-- Jumbotron -->    

        <div id="Home" class="jumbotron text-center">
            <h1>Pestizide im Rhein</h1> 
            <p>Eine Opendata-Visualisierung von Domenico und Silvan</p> 
        </div>

        <!-- Navbar -->

        <nav class="navbar navbar-inverse" data-spy="affix" data-offset-top="50">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>           
                    </button>
                    <a class="navbar-brand" href="#"><span class="glyphicon glyphicon-home"></span></a>
                </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#Home">Home</a></li>
                        <li><a href="#Story">Story</a></li>
                        <li><a href="#App">App</a></li>
                        <li class="dropdown">
                            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Weitere Informationen<span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="#NeueVerordnung">Neue Verordnung</a></li>
                                <li><a href="#AlteVerordnung">Alte Verordnung</a></li>
                                <li><a href="#Initiative">Initiative</a></li>
                            </ul>
                        </li>
                        <li><a href="#Programmierung">Programmierung</a></li>
                        <li><a href="#ueberuns">Über uns</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#"><span class="glyphicon glyphicon-envelope"></span> Kontakt</a></li>
                    </ul>
                </div>
            </div>
        </nav>


        <!-- Story -->

        <div class="container-fluid">
            <div class="panel-group text-center">
                <div class="row">
                    <div id="Story" class="panel-primary col-md-12">
                        <div class="panel-heading">
                            <h1 class="panel-title">Story</h1>
                        </div>
                        <div class="panel-body">
                            <p>Die Schweiz gilt als ein Land mit sehr sauberem und qualitativ hochwertigem Wasser. Dass man Wasser einfach vom Wasserhahn trinken kann, ist ein Privileg, um welches Schweizerinnen und Schweizer froh sind. Naheliegend ist folglich auch, dass man zu diesem Privileg Sorge tragen sollte. In Schweizer Gewässern werden deshalb regelmässig Proben entnommen. Die Messungen der RÜS werden in der App visualisiert, um einen Überblick zu verschaffen.</p>
                        </div>
                    </div>

                    <!-- App -->

                    <div id="App" class="panel-primary col-md-12">
                        <div class="panel-heading">
                            <h1 class="panel-title">Die App</h1>
                        </div>
                        <div class="panel-body">
                            <p>In der App können nun die Messungen der Pestizidkonzentrationen von 2013 bis 2017 mit den Höchstwerten nach bisherigem und neuem Reglement verglichen werden. Dazu wird auf der linken Seite das Pestizid, welches genauer angeschaut werden soll, angewählt. In der Grafik sieht man nun, wie die Messungen ausgefallen sind und dazu die Höchstwerte.</p>
                            <div>
                                <a href="#Bedienungsanleitung" class="btn btn-primary" data-toggle="collapse">Bedienungsanleitung einblenden    <span class="glyphicon glyphicon-eye-open"></span></a>
                            </div>
                            <div id="Bedienungsanleitung" class="collapse col-sm-6 col-sm-offset-3 thumb">
                                <ol class="text-left" style="background-color: darkgreen">
                                    <li>Wählen Sie ein Pestizid, dessen Messungen Sie genauer betrachten möchten</li>
                                    <li>Vergleichen Sie x mit y</li>
                                    <li>Wechseln Sie zu einem anderen Pestizid</li>
                                </ol>
                            </div>

                            <!-- Select Bar -->
                            <div class="col-md-12" id="zuordnungenBtnsDiv">
                                <label for="Auswahl" id="zuordnungenLabelText">Wählen Sie eines der Interessengebiete</label>
                                <svg id="zuordnungenBtnsSVG"  >
                                </svg>
                            </div>

                            <div class="container-fluid">
                                <div class="form-group">
                                    <label for="Auswahl" id="AuswahlPestizid">Wählen Sie hier das Pestizid, dessen Werte Sie genauer anschauen möchten:</label>
                                    <select class="form-control" id="Auswahl" >
                                        <!--<option>P1</option><option>P2</option><option>P3</option><option>P4</option>-->
                                    </select>
                                </div>
                            </div>
                            <!-- App hier einbetten -->
                            <div class="col-md-9" id="divGraphSVG">
                                <svg id="graphSVG"  >
                                </svg>
                            </div>
                            <div id="chemieDiv"class="col-md-3">
                                <h1>Chlortoluron</h1>
                                <img class="img-responsive" src="Chlortoluron.png">
                                <p id="Info">Der Richtwert von Chlortoluron wird in der neuen Verordnung nicht angepasst</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NeueVerordnung -->

        <div class="container-fluid">
            <div class="panel-group text-center">
                <div class="row">
                    <div id="NeueVerordnung" class="panel-primary col-md-4">
                        <div class="panel-heading">
                            <h1 class="panel-title">Die neue Verordnung</h1>
                        </div>
                        <div class="panel-body">
                            <p>Die Schweiz gilt als ein Land mit sehr sauberem und qualitativ hochwertigem Wasser. Dass man Wasser einfach vom Wasserhahn trinken kann, ist ein Privileg, um welches Schweizerinnen und Schweizer froh sind. Naheliegend ist folglich auch, dass man zu diesem Privileg Sorge tragen sollte. In Schweizer Gewässern werden deshalb regelmässig Proben entnommen. Die Messungen der RÜS werden in der App visualisiert, um einen Überblick zu verschaffen.</p>
                        </div>
                    </div>
                    <div id="AlteVerordnung" class="panel-primary col-md-4">
                        <div class="panel-heading">
                            <h1 class="panel-title">Die alte Verordnung</h1>
                        </div>
                        <div class="panel-body">
                            <p>In der App können nun die Messungen der Pestizidkonzentrationen von 2013 bis 2017 mit den Höchstwerten nach bisherigem und neuem Reglement verglichen werden. Dazu wird auf der linken Seite das Pestizid, welches genauer angeschaut werden soll, angewählt. In der Grafik sieht man nun, wie die Messungen ausgefallen sind und dazu die Höchstwerte.</p>
                        </div>
                    </div>
                    <div id="Initiative" class="panel-primary col-md-4">
                        <div class="panel-heading">
                            <h1 class="panel-title">Die Initiative</h1>
                        </div>
                        <div class="panel-body">
                            <p>In der App können nun die Messungen der Pestizidkonzentrationen von 2013 bis 2017 mit den Höchstwerten nach bisherigem und neuem Reglement verglichen werden. Dazu wird auf der linken Seite das Pestizid, welches genauer angeschaut werden soll, angewählt. In der Grafik sieht man nun, wie die Messungen ausgefallen sind und dazu die Höchstwerte.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Programmierung -->

        <!--

<div id="Programmierung" class="container-fluid">
<div class="panel-group text-center">
<div class="row">
<div class="panel-primary">
<div class="panel-heading">
<h1 class="panel-title">Programmierung</h1>
</div>
<div class="panel-body">
<p>Der Grundstein für unsere Applikation legen HTML und CSS</p>
</div>
<div class="col-xs-3 col-sm-3 col-md-2">
<img class="img-responsive" src="html-logo.png">
</div>
<div class="col-xs-9 col-sm-9 col-md-4">
<p>Text zu HTML</p>
</div>
<div class="col-xs-3 col-sm-3 col-md-2">
<img class="img-responsive" src="css-logo.png">
</div>
<div class="col-xs-9 col-sm-9 col-md-4">
<p>Text zu CSS</p>
</div>
<div class="col-xs-3 col-sm-3 col-md-2">
<img class="img-responsive" src="javascript-logo.png">
</div>
<div class="col-xs-9 col-sm-9 col-md-4">
<p>Text zu JS</p>
</div>
<div class="col-xs-3 col-sm-3 col-md-2">
<img class="img-responsive" src="bootstrap-logo.png">
</div>
<div class="col-xs-9 col-sm-9 col-md-4">
<p>Text zu Bootstrap</p>
</div>
</div>
</div>
</div>
</div>

-->

        <div id="Programmierung" class="container-fluid">
            <div class="panel-group">
                <div class="row">
                    <div class="panel-primary col-md-12 text-center">
                        <div class="panel-heading">
                            <h1 class="panel-title">Programmierung</h1>
                        </div>
                        <div class="panel-body">
                            <p>Text</p>
                        </div>
                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive" src="html-logo.png" alt="HTML5" style="max-height: 150px; align-content: center">
                        </div>
                        <div class="col-xs-9 col-sm-4 small well well-sm">
                            <h1>HTML 5</h1>
                            <p>jfdjoejf
                                sdfjpj
                            </p>
                            <p>fergewg
                            </p>
                            <p>dsf
                            </p>
                        </div>

                        <!-- CSS -->

                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive" src="css-logo.png" alt="CSS3" style="max-height: 150px; align-content: center">
                        </div>
                        <div class="col-xs-9 col-sm-4 small well well-sm">
                            <h1>CSS</h1>
                            <p>dfje
                            </p>
                            <p>ödsljfp
                            </p>
                            <p>rgwg
                            </p>
                        </div>

                        <!-- JS -->

                        <div class="col-xs-3 col-sm-2 col-md-2">
                            <img class="img-responsive" src="javascript-logo.png" alt="JS" style="max-height: 150px; align-content: center">
                        </div>

                        <div class="col-xs-9 col-sm-4 col-md-4 small well well-sm">
                            <h1>Java Script</h1>
                            <p>jfdjoejf
                                sdfjpj
                            </p>
                            <p>fergewg
                            </p>
                            <p>kjge</p>
                        </div>

                        <!-- Bootstrap -->

                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive" src="bootstrap-logo.png" alt="Bootstrap" style="max-height: 150px; align-content: center">
                        </div>
                        <div class="col-xs-9 col-sm-4 small well well-sm">
                            <h1>Bootstrap</h1>
                            <p>dfje
                            </p>
                            <p>ödsljfp
                            </p>
                            <p>dsgerw
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ueberuns -->

        <div id="ueberuns" class="container-fluid">
            <div class="panel-group">
                <div class="row">
                    <div class="panel-primary col-md-12 text-center">
                        <div class="panel-heading">
                            <h1 class="panel-title">Über uns</h1>
                        </div>
                        <div class="panel-body">
                            <p>Text</p>
                        </div>
                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive img-circle" src="DomenicoIapelloCropped.jpg" alt="Domenico Iapello">
                        </div>
                        <div class="col-xs-9 col-xs-pull-3 col-sm-4 col-sm-pull-0 small well well-sm">
                            <h1>Domenico Iapello</h1>
                            <ul class="list-group">
                                <li class="list-group-item"><span class="glyphicon glyphicon-education"></span> Bachelorstudent</li>
                                <li class="list-group-item"><span class="glyphicon glyphicon-search"></span> Informatik</li>
                                <li class="list-group-item"><span class="glyphicon glyphicon-envelope"></span> domenico.iapello@students.unibe.ch</li>
                            </ul>
                        </div>
                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive img-circle" src="Silvanhegi.jpg" alt="Silvan Hegi">
                        </div>
                        <div class="col-xs-9 col-sm-4 small well well-sm">
                            <h1>Silvan Hegi</h1>
                            <ul class="list-group">
                                <li class="list-group-item"><span class="glyphicon glyphicon-education"></span> Masterstudent</li>
                                <li class="list-group-item"><span class="glyphicon glyphicon-search"></span> Betriebswirtschaft</li>
                                <li class="list-group-item"><span class="glyphicon glyphicon-envelope"></span> silvan.hegi@students.unibe.ch</li>
                            </ul>
                        </div>
                        <div class="panel-footer">
                            <span class="glyphicon glyphicon-copyright-mark"> XY-Lizenz</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            //---------- Start Global Variables----------//
            var existingParametersArray; 
            var selectedParameter;
            var selectedZuordnung;
            var nestedDataAllParameter;
            var nestedDataAlleZuordnung;
            var selectedSubZuordnungArray;
            var selectedSubDataArray;
            var allData;

            var graphDivHeight;
            var graphDivWidth;

            var counter = 0;
            /*
            var firstDatum = "01/01/2013";
            var lastDatum = "12/31/2013";
            var y1MaxNew = 10;
            var y2MaxNew = 10;

            var newMaxDatumArray = ["01/01/2013","12/12/2013"];
            var newMaxYValueArray = [10,10];
            var oldMaxDatumArray = ["01/01/2013","12/12/2013"];
            var oldMaxYValueArray = [10,10];
*/
            //var newMaxLineData = [{"x":"01/01/2013", "y":10}, {"x":"12/31/2013", "y":10}];
            var newMaxLineDaten = [{"x":"01/01/2013", "y":20}, {"x":"12/31/2017", "y":20}];

            var oldMaxLineDaten = [{"x":"01/01/2013", "y":10}, {"x":"12/31/2017", "y":10}];

            //Helper Function Parse Date
            var parseTime = d3.timeParse("%m/%d/%Y");
            //var svgGraphPanel = d3.select("#graphSVG");
            var margin = {top: 50, right: 100, bottom: 50, left: 50};
            //---------- END Global Variables----------//


            //---------- Start Read Data ----------//
            //d3.csv("DatenCSV.csv", function(d) {
            d3.csv("DatenCSV.csv", function(error, d) {
                if (error) throw error;
                //return {
                //PbNahmeDatum: new Date(parseTime(d.PbNahmeDatum)), // convert "Year" column to Date

                //var parseTime = d3.timeParse("%m/%d/%Y");

                graphDivHeight = document.getElementById('divGraphSVG').clientHeight;
                graphDivWidth = document.getElementById('divGraphSVG').clientWidth;                

                console.log("Init graphDiv Height :" + graphDivHeight);
                console.log("Init graphDiv Width :" + graphDivWidth);

                d.forEach(function(d) {
                    d.PbNahmeDatum = parseTime(d.PbNahmeDatum);
                    d.Parameter = d.Parameter;
                    d.Zuordnung = d.Zuordnung;
                    d.Bestimmungsgrenze = +d.Bestimmungsgrenze;
                    d.WertText = +d.WertText;
                    d.CAS = d.CAS;
                    d.Q_m3_s = +d.Q_m3_s;
                    d.Alter_Maxwert = +d.Alter_Maxwert;
                    d.Neuer_Maxwert = +d.Neuer_Maxwert;
                    //console.log("datum from parse");
                    //console.log(d.PbNahmeDatum);
                });
                //};
                //}, 

                //function(error, rows) {
                //rows.forEach(function(d) {

                //})
                //allData = rows;
                //set initial Height and width


                //console.log(rows);
                buildZuordnungenSelection(d);
            });

            function buildZuordnungenSelection(data){

                nestZuordnungen(data);
                drawZuordnungenKreise(nestedDataAlleZuordnung);

                function drawZuordnungenKreise(data2){

                    console.log("called draw Zuordnung")

                    var rscale = d3.scaleLinear()
                    .domain([0,150000])
                    .range([10,40])

                    var heightZuordnungen = document.getElementById('zuordnungenBtnsSVG').clientHeight;
                    var widthZuordnungen = document.getElementById('zuordnungenBtnsSVG').clientWidth;

                    var zuordnungSVG = d3.select("#zuordnungenBtnsSVG");
                    var zuordKreise = zuordnungSVG.selectAll("circle")
                    .data(data2)
                    .enter()
                    .append("circle")
                    .attr("r", 5)
                    .attr("cx", function(d,i) {
                        return (widthZuordnungen/5)*(i+1);})
                    .attr("cy", function(d){
                        return (heightZuordnungen/2);})
                    .attr("r", function(d){
                        //console.log("d.length is: "+ d.values.length)
                        //console.log("d.length max "+ d3.max(data2.values.length));
                        return rscale(d.values.length);})
                    .attr("id", function(d){
                        return d.key;})
                    .style("fill", function (d){
                        return get_random_color();})
                    .on("mouseover", handleMouseEnterZuordnunge)
                    .on("mouseleave", handleMouseLeaveZuordnunge)
                    .on("click", handleClickZuordnung);

                    var text = zuordnungSVG.selectAll("text")
                    .data(data2)
                    .enter()
                    .append("text");

                    var textLabels = text
                    .attr("x", function(d,i) {
                        return (widthZuordnungen/5)*(i+1);})
                    .attr("y", function(d) {return (heightZuordnungen/2)-40})
                    .text( function (d) { return ""+d.key })
                    .attr("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "13px")
                    .attr("fill", "Black");
                }
            }


            // Helper Functions Data Nesting

            function nestZuordnungen(data){
                var nested = d3.nest()
                .key(function(d) {return d["Zuordnung"];})
                .entries(data);
                nestedDataAlleZuordnung = nested;
                //console.log("Zuordnungen from nesting");
                //console.log(nestedDataAlleZuordnung);
                //console.log(nestedDataAlleZuordnung[0].values.length);
            }

            function nestParams(data){
                var nested = d3.nest()
                .key(function(d) {return d["Parameter"];})
                .entries(data);
                nestedDataAllParameter = nested;
                //console.log("parameters from nest ");
                //console.log(nestedDataAllParameter);
                return nested;
            }
            // end     Helper Function Data nesting


            function listExistingPamaters(data){
                var existingParametersArray = [];
                //console.log("log Data befor listing parameters (is nested)");
                //console.log(data);
                for(i=0 ; i<data.length; i++){
                    //console.log(data[i].key);
                    existingParametersArray[i] = data[i].key;
                }
                existingParametersArray.sort();
                //console.log("listed Paramaters")
                //console.log(existingParametersArray);
                return existingParametersArray;
            }

            function populateParamsDropDown(keyZuordnung){

                //console.log(newMaxLine[0].x);
                //console.log(newMaxLine[0].y);

                for(i=0; i<nestedDataAlleZuordnung.length ; i++){
                    if (nestedDataAlleZuordnung[i].key == keyZuordnung){
                        selectedSubZuordnungArray = nestedDataAlleZuordnung[i].values;
                        //console.log("subdataArrayZuordnung");
                        //console.log(selectedSubZuordnungArray);
                        nestParams(selectedSubZuordnungArray);
                        renderDrDownList(listExistingPamaters(nestedDataAllParameter));

                    }
                }

                function renderDrDownList(d){
                    var entries = d3.select('#Auswahl')
                    .selectAll("option")
                    .data(d);

                    //Enter
                    entries.enter().append('option')
                        .merge(entries) //from now on, enter + update
                        .text(String);

                    //Exit
                    entries.exit().remove();

                }
                $('#Auswahl').change(function () {
                    if(counter == 0){
                        console.log("if in render and counter is " + counter);
                        counter = 1;
                        var selecteditem = $(this).find("option:selected").val(); 
                        selectedParameter = selecteditem;
                        console.log(selectedParameter);
                        getSubDataArray(nestedDataAllParameter,selectedParameter)
                        console.log("subarray change");
                        console.log(selectedSubDataArray);
                        startGraphThings(selectedSubDataArray);
                    }
                });
            }


            function startGraphThings(data){
                //console.log("data from startGraphDraws");
                //console.log(data);
                var graphSVG = d3.select("#graphSVG");

                var xScale = d3.scaleTime();
                var yScale = d3.scaleLinear();
                var ySecScale = d3.scaleLinear();

                var xAxis = d3.axisBottom().scale(xScale);
                var yAxis = d3.axisLeft().scale(yScale);
                var ySecAxis = d3.axisRight().scale(ySecScale);

                //not used line
                var lineMaxNew = d3.line();
                var lineMaxOLD = d3.line();

                var lineWasser = d3.line();

                xScale.domain(d3.extent(data.values, function(d) {
                    //console.log(d.PbNahmeDatum);
                    return d.PbNahmeDatum; }));
                yScale.domain(d3.extent(data.values, function(d) {
                    //console.log(d.WertText);
                    return d.WertText;
                    /*var maxValue = d3.max(d.WertText, function(d) { return d.WertText; });
                    if(maxValue<newMaxLineDaten[0].y && maxValue<oldMaxLineDaten[0].y) {
                        return d.WertText;
                    }else if(newMaxLineDaten[0].y==oldMaxLineDaten[0].y){
                        return [0,d.Alter_Maxwert];

                    }else if(newMaxLineDaten[0].y<oldMaxLineDaten[0].y){
                        return [0,d.Alter_Maxwert];

                    }else {
                        return [0,d.Neuer_Maxwert];
                    }*/
                }));
                ySecScale.domain(d3.extent(data.values, function(d) {
                    //console.log(d.Q_m3_s);
                    return d.Q_m3_s; }));


                var chartBoard = graphSVG.append("g")
                .attr("id", "groupGraphSVG")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var yAxisEl = chartBoard.append("g")
                .call(yAxis);

                var ySecAxisEl = chartBoard.append("g")
                .attr("transform", "translate("+ ((parseInt(d3.select('#graphSVG').style('width'), 10))-(margin.right+margin.left/2)) + "," +0+")")
                .call(ySecAxis);

                var xAxisEl = chartBoard.append("g")
                .attr("transform", "translate(0," +(parseInt(d3.select('#graphSVG').style('height'), 10) - margin.top - margin.bottom) +")")
                .call(xAxis);

                chartBoard.append("g")
                    .attr("id","yAxis")
                    .append("text")
                    .attr("fill", "#000")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", "0.71em")
                    .attr("text-anchor", "middle")
                    .text("ng / L");

                chartBoard.append("g")
                    .attr("id","ySecAxis")
                    .attr("transform", "translate("+ ((parseInt(d3.select('#graphSVG').style('width'), 10))-(margin.right+margin.left/2)) + "," +0+")")
                    .append("text")
                    .attr("fill", "#000")
                    .attr("transform", "rotate(90)")
                    .attr("y", 6)
                    .attr("dy", "0.71em")
                    .attr("text-anchor", "middle")
                    .text("Q_M3/S");

                var pathMaxNEW = chartBoard.append("path")
                .data(newMaxLineDaten)
                .attr("id","pathMAXNEW")
                .style('fill', 'none')
                .style('stroke', function (d){
                    console.log("pathMAxNEw Called");
                    return "Red";})
                .style('stroke-width', '2px');


                var pathMaxOLD = chartBoard.append("path")
                .data(oldMaxLineDaten)
                .attr("id","pathMAXOLD")
                .style('fill', 'none')
                .style('stroke', function (d){
                    console.log("pathMAxOld Called");
                    return "Yellow";})
                .style('stroke-width', '2px');

                var pathWasser = chartBoard.append("path")
                .data([selectedSubDataArray])
                    //function(){
                    //console.log("selected Subdata Array in pathWasser");
                    //console.log(selectedSubDataArray);
                    //return [selectedSubDataArray];
                //})
                .attr("id","pathWasser")
                .style('fill', 'none')
                .style('stroke', function (d){
                    console.log("pathWasser Called ");
                    console.log("pathWasser data is");
                    console.log([selectedSubDataArray]);
                    return "Blue";})
                .style('stroke-width', '2px');

                updateChartElements();

                function updateChartElements(){

                    console.log("updateChartAxis");
                    //console.log(data);
                    //console.log("chartdraw graphDiv height "+ graphDivHeight);

                    xScale.domain(d3.extent(selectedSubDataArray.values, function(d) {
                        //console.log(d.PbNahmeDatum);
                        return d.PbNahmeDatum; }));
                    yScale.domain(d3.extent(selectedSubDataArray.values, function(d) {
                        //console.log(d.WertText);
                        return d.WertText; }));
                    ySecScale.domain(d3.extent(selectedSubDataArray.values, function(d) {
                        //console.log(d.Q_m3_s);
                        return d.Q_m3_s; }));

                    //console.log("chartdraw height "+ height);

                    width = parseInt(d3.select('#divGraphSVG').style('width'), 10) - margin.left - margin.right;
                    //console.log("chartdraw width "+ width);
                    //console.log("width is: " +width);
                    xScale.range([0, width]);
                    xAxis.scale(xScale);
                    xAxisEl.call(xAxis);

                    height = +parseInt(d3.select('#divGraphSVG').style('height'), 10) - margin.top - margin.bottom;
                    //console.log("width is: " +height);
                    yScale.range([height,0]);
                    yAxis.scale(yScale);
                    yAxisEl.call(yAxis);

                    ySecScale.range([height,0]);
                    ySecAxis.scale(ySecScale);
                    ySecAxisEl.call(ySecAxis);
                }

                function drawNewMaxLine(){
                    console.log("drawNewMaxLine called");
                    lineMaxNew.x(function(d) { 
                        //console.log(d.x);
                        return xScale(parseTime(d.x)); })
                        .y(function(d) { 
                        //console.log(d.y);                        
                        return yScale(d.y); });


                    pathMaxNEW.datum(newMaxLineDaten)
                        .attr("fill", "none")
                        .attr("stroke", "gray")
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-linecap", "round")
                        .attr("stroke-width", 0.5)
                        .attr("d", lineMaxNew);

                }
                drawNewMaxLine();

                function drawOldMaxLine(){
                    console.log("drawOldMaxLine called");
                    lineMaxOLD.x(function(d) { 
                        //console.log(d.x);
                        return xScale(parseTime(d.x)); })
                        .y(function(d) { 
                        //console.log(d.y);                        
                        return yScale(d.y); });


                    pathMaxOLD.datum(oldMaxLineDaten)
                        .attr("fill", "none")
                        .attr("stroke", "gray")
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-linecap", "round")
                        .attr("stroke-width", 0.5)
                        .attr("d", lineMaxOLD);

                }
                drawOldMaxLine();

                function drawWasserLine(){
                    console.log("drawWasserLine methode called");
                    lineWasser.x(function(d) { 
                        console.log("d.Datum_Start is: ");
                        console.log(d.values);
                        return xScale(d.values); })
                        .y(function(d) { 
                        console.log("d.Q_m3_s is: ");
                        console.log(d.values);
                        return ySecScale(d.values); });


                    pathWasser.datum([selectedSubDataArray])
                        .attr("fill", "none")
                        .attr("stroke", function (d){
                        console.log("drawWasserLine path methode");
                        return "Blue";})
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-linecap", "round")
                        .attr("stroke-width", 0.5)
                        .attr("d", lineWasser);

                }
                drawWasserLine();

                function addNewKreise(){
                    var kreise = chartBoard.selectAll("circle")
                    .data(selectedSubDataArray.values)
                    .enter()
                    .append("circle")
                    .attr("r", 5)
                    .attr("cx", function(d) {
                        //console.log(d);
                        //console.log(d.PbNahmeDatum);
                        //console.log(d.WertText);
                        //console.log(xScale(d.PbNahmeDatum));
                        return xScale(d.PbNahmeDatum); })
                    .attr("cy", function(d) { 
                        //console.log(d.WertText);
                        return yScale(d.WertText); })
                    .attr("stroke", "black")
                    .style("fill", function(d){if(d.WertText>10){return "red";}else{return "green";}})
                    .on("mouseover", handleMouseEnterData)
                    .on("mouseout", handleMouseLeaveData);
                }

                function updateKreise(){
                    chartBoard.selectAll("circle")
                        .data(selectedSubDataArray.values)
                        .transition()
                        .duration(250)
                        .style("fill",function(d){if(d.WertText>10){return "red";}else{return "green";}} )
                        .attr("cx", function(d){
                        return xScale(d.PbNahmeDatum);
                    })
                        .attr("cy", function(d){
                        return yScale(d.WertText);
                    });
                }

                function removeKreise(){
                    chartBoard.selectAll("circle")
                        .data(selectedSubDataArray.values)
                        .exit()
                        .transition()
                        .duration(250)
                        .style("fill", function(d){if(d.WertText>10){return "red";}else{return "green";}} )
                        .attr("r", 0)
                        .remove();
                }

                //updateChartAxis();
                addNewKreise();

                $('#Auswahl').change(function () {
                    if (counter == 1){
                        console.log(" change in startDrawGraph counter is "+ counter);
                        var selecteditem = $(this).find("option:selected").val(); 
                        selectedParameter = selecteditem;
                        console.log(selectedParameter);
                        getSubDataArray(nestedDataAllParameter,selectedParameter)
                        console.log("subarray change");
                        console.log(selectedSubDataArray);
                        //startGraphDraws(selectedSubDataArray);
                        updateChartElements();
                        addNewKreise();
                        updateKreise();
                        removeKreise();
                        drawNewMaxLine();
                        drawOldMaxLine();
                        drawWasserLine();
                    }
                });

                window.addEventListener('resize', function() {
                    console.log("The window was resized!");
                    //var myDiv = document.getElementById('divGraphSVG');
                    var myDiv = document.getElementById('graphSVG');
                    //console.log(myDiv.clientHeight);
                    //console.log(myDiv.clientWidth);
                    graphDivHeight = document.getElementById('divGraphSVG').clientHeight;
                    graphDivWidth = document.getElementById('divGraphSVG').clientWidth;
                    updateChartElements();
                    addNewKreise();
                    updateKreise();
                    removeKreise();
                    drawNewMaxLine();
                    drawOldMaxLine();
                    drawWasserLine();
                });
            }


            //---------- END Extract ParameterList----------//

            //---------- Start getSelectBoxSelectedValue ----------//

            //---------- END getSelectSelectedValue----------//

            //---------- START getSelectedSubDataArray----------//
            function getSubDataArray(data, key){
                //console.log(data);
                //console.log(key);
                subdataArray = [];
                for(i=0 ; i<data.length; i++){
                    if(data[i].key === key){
                        subdataArray = data[i];
                    }
                }
                selectedSubDataArray = subdataArray;
                /*
                var minTime = d3.min(subdataArray.values, function(d) { return d.PbNahmeDatum; });
                console.log("minTime is " + minTime);

                var testMin = d3.min(newMaxYValueArray);
                console.log("testMin is " + testMin);

                var minValue = d3.min(subdataArray.values, function(d) { return d.WertText; });
                console.log("minValue is " + minValue);
                */

                /*console.log("before Maxline NEW");
                console.log(newMaxLineDaten[0]);
                console.log(newMaxLineDaten[1]);
                newMaxLineDaten[0].x = subdataArray.values[0].Neuer_Maxwert;
                newMaxLineDaten[1].x = subdataArray.values[0].Neuer_Maxwert;
                newMaxLineDaten[0].y = d3.min(subdataArray.values, function(d) { return d.PbNahmeDatum; });
                newMaxLineDaten[1].y = d3.max(subdataArray.values, function(d) { return d.PbNahmeDatum; });
                console.log("after Maxline NEW");
                console.log(newMaxLineDaten[0]);
                console.log(newMaxLineDaten[1]);


                console.log("before Maxline OLD");
                console.log(oldMaxLineDaten[0]);
                console.log(oldMaxLineDaten[1]);
                oldMaxLineDaten[0].x = subdataArray.values[0].Alter_Maxwert;
                oldMaxLineDaten[1].x = subdataArray.values[0].Alter_Maxwert;
                oldMaxLineDaten[0].y = d3.min(subdataArray.values, function(d) { return d.PbNahmeDatum; });
                oldMaxLineDaten[1].y = d3.max(subdataArray.values, function(d) { return d.PbNahmeDatum; });
                console.log("after Maxline OLD");
                console.log(oldMaxLineDaten[0]);
                console.log(oldMaxLineDaten[1]);
                */
                //hubi
                //console.log(subdataArray);
                //return subdataArray;
            }           

            function handleMouseEnterData(d, i) {
                d3.select(this)
                    .attr("opacity", 1.0)
                    .attr("r", 10)
                    .attr("stroke", "black")
                    .style("fill","yellow");
                //d3.select(this).style("fill","green");
            }

            function handleMouseLeaveData(d, i) {
                d3.select(this)
                    .attr("r", 5)
                    .style("fill",function(d){if(d.WertText>10){return "red";}else{return "green";}} );
            }

            function handleMouseEnterZuordnunge(d, i) {
                d3.select(this)
                    .attr("stroke", "black");
            }

            function handleMouseLeaveZuordnunge(d, i) {
                d3.select(this)
                    .attr("stroke", "white")
            }

            function handleClickZuordnung (d,i){
                d3.select(this)
                console.log(d.key);
                selectedZuordnung = d.key; 
                populateParamsDropDown(selectedZuordnung);
            }

            function get_random_color() {
                return '#'+Math.floor(Math.random()*16777215).toString(16);
            }


        </script>
    </body>
</html>