<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

        <!-- d3 library -->
        <script src="https://d3js.org/d3.v4.min.js"></script>

        <!-- jQuery library -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

        <!-- Latest compiled JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

        <link rel="stylesheet" type="text/css" href="APPCSS.css">

    </head>
    <body data-spy="scroll" data-target=".navbar" data-offset="50">

        <!-- Jumbotron -->    

        <div id="Home" class="jumbotron text-center">
            <h1>Pestizide im Rhein</h1> 
            <p>Eine Opendata-Visualisierung von Domenico und Silvan</p> 
        </div>

        <!-- Navbar -->

        <nav class="navbar navbar-inverse" data-spy="affix" data-offset-top="50">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>           
                    </button>
                    <a class="navbar-brand" href="#"><span class="glyphicon glyphicon-home"></span></a>
                </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#Home">Home</a></li>
                        <li><a href="#Story">Story</a></li>
                        <li><a href="#App">App</a></li>
                        <li class="dropdown">
                            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Weitere Informationen<span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="#NeueVerordnung">Neue Verordnung</a></li>
                                <li><a href="#AlteVerordnung">Alte Verordnung</a></li>
                                <li><a href="#Initiative">Initiative</a></li>
                            </ul>
                        </li>
                        <li><a href="#Programmierung">Programmierung</a></li>
                        <li><a href="#ueberuns">Über uns</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#"><span class="glyphicon glyphicon-envelope"></span> Kontakt</a></li>
                    </ul>
                </div>
            </div>
        </nav>


        <!-- Story -->

        <div class="container-fluid">
            <div class="panel-group text-center">
                <div class="row">
                    <div id="Story" class="panel-primary col-md-12">
                        <div class="panel-heading">
                            <h1 class="panel-title">Story</h1>
                        </div>
                        <div class="panel-body">
                            <p>Die Schweiz gilt als ein Land mit sehr sauberem und qualitativ hochwertigem Wasser. Dass man Wasser einfach vom Wasserhahn trinken kann, ist ein Privileg, um welches Schweizerinnen und Schweizer froh sind. Naheliegend ist folglich auch, dass man zu diesem Privileg Sorge tragen sollte. In Schweizer Gewässern werden deshalb regelmässig Proben entnommen. Die Messungen der RÜS werden in der App visualisiert, um einen Überblick zu verschaffen.</p>
                        </div>
                    </div>

                    <!-- App -->

                    <div id="App" class="panel-primary col-md-12">
                        <div class="panel-heading">
                            <h1 class="panel-title">Die App</h1>
                        </div>
                        <div class="panel-body">
                            <p>In der App können nun die Messungen der Pestizidkonzentrationen von 2013 bis 2017 mit den Höchstwerten nach bisherigem und neuem Reglement verglichen werden. Dazu wird auf der linken Seite das Pestizid, welches genauer angeschaut werden soll, angewählt. In der Grafik sieht man nun, wie die Messungen ausgefallen sind und dazu die Höchstwerte.</p>
                            <div>
                                <a href="#Bedienungsanleitung" class="btn btn-primary" data-toggle="collapse">Bedienungsanleitung einblenden    <span class="glyphicon glyphicon-eye-open"></span></a>
                            </div>
                            <div id="Bedienungsanleitung" class="collapse col-sm-6 col-sm-offset-3 thumb">
                                <ol class="text-left" style="background-color: darkgreen">
                                    <li>Wählen Sie ein Pestizid, dessen Messungen Sie genauer betrachten möchten</li>
                                    <li>Vergleichen Sie x mit y</li>
                                    <li>Wechseln Sie zu einem anderen Pestizid</li>
                                </ol>
                            </div>

                            <!-- Select Bar -->

                            <div class="container-fluid">
                                <div class="form-group">
                                    <label for="Auswahl" id="AuswahlPestizid">Wählen Sie hier das Pestizid, dessen Werte Sie genauer anschauen möchten:</label>
                                    <select class="form-control" id="Auswahl" >
                                        <!--<option>P1</option><option>P2</option><option>P3</option><option>P4</option>-->
                                    </select>
                                </div>
                            </div>

                            <!-- App hier einbetten -->
                            <div class="col-md-9" id="divGraphSVG">
                                <svg id="graphSVG"  >
                                </svg>
                                <!--<img class="img-responsive" src="appscreenshot.jpg" style="height: 500px; width: auto; align: center">-->
                            </div>
                            <div id="chemieDiv"class="col-md-3">
                                <h1>Chlortoluron</h1>
                                <img class="img-responsive" src="Chlortoluron.png">
                                <p id="Info">Der Richtwert von Chlortoluron wird in der neuen Verordnung nicht angepasst</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NeueVerordnung -->

        <div class="container-fluid">
            <div class="panel-group text-center">
                <div class="row">
                    <div id="NeueVerordnung" class="panel-primary col-md-4">
                        <div class="panel-heading">
                            <h1 class="panel-title">Die neue Verordnung</h1>
                        </div>
                        <div class="panel-body">
                            <p>Die Schweiz gilt als ein Land mit sehr sauberem und qualitativ hochwertigem Wasser. Dass man Wasser einfach vom Wasserhahn trinken kann, ist ein Privileg, um welches Schweizerinnen und Schweizer froh sind. Naheliegend ist folglich auch, dass man zu diesem Privileg Sorge tragen sollte. In Schweizer Gewässern werden deshalb regelmässig Proben entnommen. Die Messungen der RÜS werden in der App visualisiert, um einen Überblick zu verschaffen.</p>
                        </div>
                    </div>
                    <div id="AlteVerordnung" class="panel-primary col-md-4">
                        <div class="panel-heading">
                            <h1 class="panel-title">Die alte Verordnung</h1>
                        </div>
                        <div class="panel-body">
                            <p>In der App können nun die Messungen der Pestizidkonzentrationen von 2013 bis 2017 mit den Höchstwerten nach bisherigem und neuem Reglement verglichen werden. Dazu wird auf der linken Seite das Pestizid, welches genauer angeschaut werden soll, angewählt. In der Grafik sieht man nun, wie die Messungen ausgefallen sind und dazu die Höchstwerte.</p>
                        </div>
                    </div>
                    <div id="Initiative" class="panel-primary col-md-4">
                        <div class="panel-heading">
                            <h1 class="panel-title">Die Initiative</h1>
                        </div>
                        <div class="panel-body">
                            <p>In der App können nun die Messungen der Pestizidkonzentrationen von 2013 bis 2017 mit den Höchstwerten nach bisherigem und neuem Reglement verglichen werden. Dazu wird auf der linken Seite das Pestizid, welches genauer angeschaut werden soll, angewählt. In der Grafik sieht man nun, wie die Messungen ausgefallen sind und dazu die Höchstwerte.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Programmierung -->

        <!--

<div id="Programmierung" class="container-fluid">
<div class="panel-group text-center">
<div class="row">
<div class="panel-primary">
<div class="panel-heading">
<h1 class="panel-title">Programmierung</h1>
</div>
<div class="panel-body">
<p>Der Grundstein für unsere Applikation legen HTML und CSS</p>
</div>
<div class="col-xs-3 col-sm-3 col-md-2">
<img class="img-responsive" src="html-logo.png">
</div>
<div class="col-xs-9 col-sm-9 col-md-4">
<p>Text zu HTML</p>
</div>
<div class="col-xs-3 col-sm-3 col-md-2">
<img class="img-responsive" src="css-logo.png">
</div>
<div class="col-xs-9 col-sm-9 col-md-4">
<p>Text zu CSS</p>
</div>
<div class="col-xs-3 col-sm-3 col-md-2">
<img class="img-responsive" src="javascript-logo.png">
</div>
<div class="col-xs-9 col-sm-9 col-md-4">
<p>Text zu JS</p>
</div>
<div class="col-xs-3 col-sm-3 col-md-2">
<img class="img-responsive" src="bootstrap-logo.png">
</div>
<div class="col-xs-9 col-sm-9 col-md-4">
<p>Text zu Bootstrap</p>
</div>
</div>
</div>
</div>
</div>

-->

        <div id="Programmierung" class="container-fluid">
            <div class="panel-group">
                <div class="row">
                    <div class="panel-primary col-md-12 text-center">
                        <div class="panel-heading">
                            <h1 class="panel-title">Programmierung</h1>
                        </div>
                        <div class="panel-body">
                            <p>Text</p>
                        </div>
                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive" src="html-logo.png" alt="HTML5" style="max-height: 150px; align-content: center">
                        </div>
                        <div class="col-xs-9 col-sm-4 small well well-sm">
                            <h1>HTML 5</h1>
                            <p>jfdjoejf
                                sdfjpj
                            </p>
                            <p>fergewg
                            </p>
                            <p>dsf
                            </p>
                        </div>

                        <!-- CSS -->

                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive" src="css-logo.png" alt="CSS3" style="max-height: 150px; align-content: center">
                        </div>
                        <div class="col-xs-9 col-sm-4 small well well-sm">
                            <h1>CSS</h1>
                            <p>dfje
                            </p>
                            <p>ödsljfp
                            </p>
                            <p>rgwg
                            </p>
                        </div>

                        <!-- JS -->

                        <div class="col-xs-3 col-sm-2 col-md-2">
                            <img class="img-responsive" src="javascript-logo.png" alt="JS" style="max-height: 150px; align-content: center">
                        </div>

                        <div class="col-xs-9 col-sm-4 col-md-4 small well well-sm">
                            <h1>Java Script</h1>
                            <p>jfdjoejf
                                sdfjpj
                            </p>
                            <p>fergewg
                            </p>
                            <p>kjge</p>
                        </div>

                        <!-- Bootstrap -->

                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive" src="bootstrap-logo.png" alt="Bootstrap" style="max-height: 150px; align-content: center">
                        </div>
                        <div class="col-xs-9 col-sm-4 small well well-sm">
                            <h1>Bootstrap</h1>
                            <p>dfje
                            </p>
                            <p>ödsljfp
                            </p>
                            <p>dsgerw
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ueberuns -->

        <div id="ueberuns" class="container-fluid">
            <div class="panel-group">
                <div class="row">
                    <div class="panel-primary col-md-12 text-center">
                        <div class="panel-heading">
                            <h1 class="panel-title">Über uns</h1>
                        </div>
                        <div class="panel-body">
                            <p>Text</p>
                        </div>
                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive img-circle" src="DomenicoIapelloCropped.jpg" alt="Domenico Iapello">
                        </div>
                        <div class="col-xs-9 col-xs-pull-3 col-sm-4 col-sm-pull-0 small well well-sm">
                            <h1>Domenico Iapello</h1>
                            <ul class="list-group">
                                <li class="list-group-item"><span class="glyphicon glyphicon-education"></span> Bachelorstudent</li>
                                <li class="list-group-item"><span class="glyphicon glyphicon-search"></span> Informatik</li>
                                <li class="list-group-item"><span class="glyphicon glyphicon-envelope"></span> domenico.iapello@students.unibe.ch</li>
                            </ul>
                        </div>
                        <div class="col-xs-3 col-sm-2">
                            <img class="img-responsive img-circle" src="Silvanhegi.jpg" alt="Silvan Hegi">
                        </div>
                        <div class="col-xs-9 col-sm-4 small well well-sm">
                            <h1>Silvan Hegi</h1>
                            <ul class="list-group">
                                <li class="list-group-item"><span class="glyphicon glyphicon-education"></span> Masterstudent</li>
                                <li class="list-group-item"><span class="glyphicon glyphicon-search"></span> Betriebswirtschaft</li>
                                <li class="list-group-item"><span class="glyphicon glyphicon-envelope"></span> silvan.hegi@students.unibe.ch</li>
                            </ul>
                        </div>
                        <div class="panel-footer">
                            <span class="glyphicon glyphicon-copyright-mark"> XY-Lizenz</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            //---------- Start Global Variables----------//
            var existingParametersArray; 
            var selectedParameter;
            var nestedData;
            var selectedSubDataArray;
            var graphDivHeight;
            var graphDivWidth;
            //var svgGraphPanel = d3.select("#graphSVG");
            var margin = {top: 50, right: 50, bottom: 50, left: 50};
            //---------- END Global Variables----------//


            //---------- Start Read Data ----------//
            d3.json("2013-Cut-Pestizide-JSON.json", function(error, data) {
                if (error) throw error;

                //set initial Height and width
                graphDivHeight = document.getElementById('graphSVG').clientHeight;
                graphDivWidth = document.getElementById('divGraphSVG').clientWidth;
                //console.log("Init graphDiv Height :" + graphDivHeight);
                //console.log("Init graphDiv Width :" + graphDivWidth);

                //Helper Function Parse Date
                var parseTime = d3.timeParse("%d.%m.%Y");

                data.forEach(function(d) {
                    d.Datum_Start = parseTime(d.Datum_Start);
                    //console.log(d.Datum_Start);
                    d.M_in_mg_L = +d.M_in_mg_L;
                    //console.log(d.M_in_mg_L);
                });

                // Helper Function Nest Data
                function nestParams(data){
                    var nested = d3.nest()
                    .key(function(d) {return d["Parameter"];})
                    .entries(data);
                    nestedData = nested;
                    return nested;
                }
                //console.log(listExistingPamaters(nestParams(data)));
                existingParametersArray = listExistingPamaters(nestParams(data));

                //Populate "Auswahl"
                d3.select('#Auswahl')
                    .selectAll("option")
                    .data(existingParametersArray)
                    .enter()
                    .append("option")
                    .text(String);

                //selectedSubDataArray = 
                getSubDataArray(nestedData,"Atrazin");
                console.log("from init");
                console.log(selectedSubDataArray);
                //drawChart(selectedSubDataArray);


                //console.log(existingParametersArray);

                chartShizzl();

            }); 

            function chartShizzl(){

                var graphSVG = d3.select("#graphSVG");

                //var height = +parseInt(d3.select('#graphSVG').style('height'), 10) - margin.top - margin.bottom;
                //console.log("height is: " +height);

                var xScale = d3.scaleTime();//.range([0, width]);
                var yScale = d3.scaleLinear();//.rangeRound([height, 0]);
                //var yRScale = d3.scaleLinear();

                var xAxis = d3.axisBottom().scale(xScale);
                var yAxis = d3.axisLeft().scale(yScale);
                //var yRAxis = d3.axisRight().scale(yRAxis);                                

                //not used line
                //var line = d3.line();

                xScale.domain(d3.extent(selectedSubDataArray.values, function(d) {
                    //console.log(d.Datum_Start);
                    return d.Datum_Start; }));
                yScale.domain(d3.extent(selectedSubDataArray.values, function(d) {
                    //console.log(d.M_in_mg_L);
                    return d.M_in_mg_L; }));

                //nach was scale .. durchfluss bleibt über das jahr oder nach was ? 
                //yRScale.domain(d3.extent(selectedSubDataArray.values, function(d,i) {
                //console.log(d.M_in_mg_L);
                //return d[i] }));

                var chartBoard = graphSVG.append("g")
                .attr("id", "groupGraphSVG")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                ;

                //var height = +graphDivHeight - margin.top -margin.bottom;

                var yAxisEl = chartBoard.append("g")
                .call(yAxis);

                var xAxisEl = chartBoard.append("g")
                .attr("transform", "translate(0," +(parseInt(d3.select('#graphSVG').style('height'), 10) - margin.top - margin.bottom) +")")
                .call(xAxis);

                //not used line
                /*var path = chartBoard.append("path")
                .data(selectedSubDataArray.values)
                .attr("id","path")
                .style('fill', 'none')
                .style('stroke', 'steelblue')
                .style('stroke-width', '2px');*/

                /*chartBoard.append("g")
                    .attr("id","yAxis")
                    .call(yAxis)
                    .append("text")
                    .attr("fill", "#000")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", "0.71em")
                    .attr("text-anchor", "middle")
                    .text("ng / L");*/



                function drawChart(){

                    console.log("drawChartCalled");
                    //console.log(data);
                    //console.log("chartdraw graphDiv height "+ graphDivHeight);

                    xScale.domain(d3.extent(selectedSubDataArray.values, function(d) {
                        //console.log(d.Datum_Start);
                        return d.Datum_Start; }));
                    yScale.domain(d3.extent(selectedSubDataArray.values, function(d) {
                        //console.log(d.M_in_mg_L);
                        return d.M_in_mg_L; }));

                    //console.log("chartdraw height "+ height);

                    width = parseInt(d3.select('#divGraphSVG').style('width'), 10) - margin.left - margin.right;
                    //console.log("chartdraw width "+ width);
                    console.log("width is: " +width);
                    xScale.range([0, width]);
                    xAxis.scale(xScale);
                    xAxisEl.call(xAxis);

                    height = +parseInt(d3.select('#graphSVG').style('height'), 10) - margin.top - margin.bottom;
                    console.log("width is: " +height);
                    yScale.range([height,0]);
                    yAxis.scale(yScale);
                    yAxisEl.call(yAxis);

                    chartBoard.append("g")
                        .attr("id","yAxis")
                        .call(yAxis)
                        .append("text")
                        .attr("fill", "#000")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", "0.71em")
                        .attr("text-anchor", "middle")
                        .text("ng / L");

                    //not used line
                    /*
                    line.x(function(d) { 
                        //console.log(d.Datum_Start);
                        return xScale(d.Datum_Start); })
                        .y(function(d) { return yScale(d.M_in_mg_L); });


                    path.datum(selectedSubDataArray.values)
                        .attr("fill", "none")
                        .attr("stroke", "gray")
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-linecap", "round")
                        .attr("stroke-width", 0.5)
                        .attr("d", line);
                    */
                }
                
                function addNewKreise(){
                    var kreise = chartBoard.selectAll("circle")
                    .data(selectedSubDataArray.values)
                    .enter()
                    .append("circle")
                    .attr("r", 7)
                    .attr("cx", function(d) {
                        //console.log(d);
                        //console.log(d.Datum_Start);
                        //console.log(d.M_in_mg_L);
                        //console.log(xScale(d.Datum_Start));
                        return xScale(d.Datum_Start); })
                    .attr("cy", function(d) { 
                        //console.log(d.M_in_mg_L);
                        return yScale(d.M_in_mg_L); })
                    .attr("stroke", "black")
                    .style("fill", "Blue")
                    .on("mouseover", handleMouseEnter)
                    .on("mouseout", handleMouseLeave)
                }
                
                function updateKreise(){
                    chartBoard.selectAll("circle")
                    .data(selectedSubDataArray.values)
                    .transition()
                    .duration(1000)
                    .style("fill","green")
                    .attr("cx", function(d){
                        return xScale(d.Datum_Start);
                    })
                    .attr("cy", function(d){
                        return yScale(d.M_in_mg_L);
                    });
                }
                
                function removeKreise(){
                    chartBoard.selectAll("circle")
                    .data(selectedSubDataArray.values)
                    .exit()
                    .transition()
                    .duration(1000)
                    .style("fill", "black")
                    .attr("r", 0)
                    .remove();
                }

                drawChart();
                addNewKreise();

                window.addEventListener('resize', function() {
                    console.log("The window was resized!");
                    //var myDiv = document.getElementById('divGraphSVG');
                    var myDiv = document.getElementById('graphSVG');
                    //console.log(myDiv.clientHeight);
                    //console.log(myDiv.clientWidth);
                    graphDivHeight = document.getElementById('divGraphSVG').clientHeight;
                    graphDivWidth = document.getElementById('divGraphSVG').clientWidth;
                    drawChart();
                    addNewKreise();
                    updateKreise();
                    removeKreise();
                    
                });
            
            $('#Auswahl').change(function () {
                var selecteditem = $(this).find("option:selected").val(); 
                selectedParameter = selecteditem;
                //console.log(selectedParameter);
                getSubDataArray(nestedData,selectedParameter)
                //console.log("subarray change");
                console.log(selectedSubDataArray);
                //chartShizzl();
                drawChart();
                updateKreise();
                removeKreise();
            });
                
            }

            function listExistingPamaters(data){
                var existingParametersArray = [];
                //console.log("log Data befor listing parameters (is nested)");
                //console.log(data);
                for(i=0 ; i<data.length; i++){
                    //console.log(data[i].key);
                    existingParametersArray[i] = data[i].key;
                }
                //console.log(existingParametersArray);
                existingParametersArray.sort();
                return existingParametersArray;
                
                
            }
            //---------- END Extract ParameterList----------//

            //---------- Start getSelectBoxSelectedValue ----------//
            
            //---------- END getSelectSelectedValue----------//

            //---------- START getSelectedSubDataArray----------//
            function getSubDataArray(data, key){
                //console.log(data);
                //console.log(key);
                subdataArray = [];
                for(i=0 ; i<data.length; i++){
                    if(data[i].key === key){
                        subdataArray = data[i];
                    }
                }
                selectedSubDataArray = subdataArray;
                //console.log(subdataArray);
                //return subdataArray;
            }
            //---------- END getSelectedSubDataArray----------//
            //---------- Start Handlers-----------//
            /* window.addEventListener('resize', function() {
                    console.log("The window was resized!");
                    //var myDiv = document.getElementById('divGraphSVG');
                    var myDiv = document.getElementById('graphSVG');
                    //console.log(myDiv.clientHeight);
                    //console.log(myDiv.clientWidth);
                    graphDivHeight = document.getElementById('divGraphSVG').clientHeight;
                    graphDivWidth = document.getElementById('divGraphSVG').clientWidth;

                });    */            

            function handleMouseEnter(d, i) {
                d3.select(this)
                    .attr("opacity", 1.0)
                    .attr("r", 10)
                    .attr("stroke", "black")
                    .style("fill","yellow");
                //d3.select(this).style("fill","green");
            }

            function handleMouseLeave(d, i) {
                d3.select(this)
                    .attr("r", 7)
                    .style("fill","blue");
            }


        </script>
    </body>
</html>